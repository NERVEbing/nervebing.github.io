<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>GRPC | Lv's Playground</title>
<meta name=keywords content><meta name=description content="Lv's Playground"><meta name=author content="L"><link rel=canonical href=https://lvlv.fun/tags/grpc/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://lvlv.fun/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lvlv.fun/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://lvlv.fun/favicon-32x32.png><link rel=apple-touch-icon href=https://lvlv.fun/apple-touch-icon.png><link rel=mask-icon href=https://lvlv.fun/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://lvlv.fun/tags/grpc/index.xml><link rel=alternate hreflang=en href=https://lvlv.fun/tags/grpc/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.7.0/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fontsource/mononoki@5.0.7/index.min.css><script defer src=https://hi.lvlv.fun/hi.js data-website-id=685c7d96-4af8-4152-8071-ff743ac81947 data-domains=lvlv.fun></script><script>const isLightMode=function(){return localStorage.getItem("pref-theme")!=="dark"},getModeSwitch=function(){return document.getElementById("theme-toggle")}</script><meta property="og:title" content="GRPC"><meta property="og:description" content="Lv's Playground"><meta property="og:type" content="website"><meta property="og:url" content="https://lvlv.fun/tags/grpc/"><meta property="og:site_name" content="Lv's Playground"><meta name=twitter:card content="summary"><meta name=twitter:title content="GRPC"><meta name=twitter:description content="Lv's Playground"></head><body class="list dark" id=top><header class=header><nav class=nav><div class=logo><a href=https://lvlv.fun/ accesskey=h title="Started (Alt + H)"><img src=https://lvlv.fun/apple-touch-icon.png alt aria-label=logo height=35>Started</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://lvlv.fun/latest/ title=Latest><span>Latest</span></a></li><li><a href=https://lvlv.fun/navigation/ title=Navigation><span>Navigation</span></a></li><li><a href=https://lvlv.fun/archives/ title=Archives><span>Archives</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://lvlv.fun/>Home</a>&nbsp;»&nbsp;<a href=https://lvlv.fun/tags/>Tags</a></div><h1>GRPC
<a href=/tags/grpc/index.xml title=RSS aria-label=RSS><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" height="23"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></h1></header><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>使用 Rust 构建 gRPC 微服务</h2></header><div class=entry-content><p>前言 当前越来越多的公司基于 Google gRPC 通信框架来构建微服务体系，比较流行的是使用 Go/Java/C++ 这样的主流编程语言来编写服务端，我们今天来尝试使用 Rust 语言来实现一个 gRPC 服务端/客户端。
打开官方文档可以看到目前 Rust 并不在 gRPC 官方支持的语言列表中：
Supported languages
C# C++ Dart Go Java Kotlin Node Objective-C PHP Python Ruby 不过不用担心这个问题。我们知道只要某个语言兼容了基于 C/C++ 编写的 gRPC 的核心库 ，那么该语言就可以完美支持 gRPC。目前 Rust 可以实现 gRPC 的主流 crate 如下：
tonic grpc-rs grpc-rust 以上三种任选其一都可以，只是 grpc-rs/grpc-rust 当前还处于开发状态，我们在这里使用 tonic 包。
构建程序 首先检查你的 Rust 版本：
$ rustc --version rustc 1.61.0 (fe5b13d68 2022-05-18) tonic 适用于 1.56 及以上，如果低于这个版本，你应该先更新你的 Rust 编译器：
$ rustup update stable 确保你已经提前安装了 protobuf：
...</p></div><footer class=entry-footer><span title='2022-05-30 02:25:11 +0800 +0800'>2022-05-30</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;L</footer><a class=entry-link aria-label="post link to 使用 Rust 构建 gRPC 微服务" href=https://lvlv.fun/posts/2022-05-30/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>gRPC Connection reset by peer 问题</h2></header><div class=entry-content><p>前提 因产品需求，需用 PHP（v7.0.12）调用 k8s 集群中 gRPC（golang@1.12.0）服务。
问题 经过 dev 环境测试，当 php-fpm 启动后第一次调用或者距离上次调用时间 20 分钟后左右，再次请求 gRPC 微服务接口，就会返回 Connection reset by peer 错误，说明 gRPC 服务端或者客户端主动关闭连接了。继续发起请求到服务端，又恢复正常。
思考 经查阅相关资料，发现问题可能出现在 k8s 集群的 kube-proxy 模式上。当前 k8s 环境 (dev) 下的 kube-proxy 为 ipvs 模式，服务端与客户端之间通信如下：
把上图 client 看成是 apsopen-inside 服务 pod，Backend pod(1~3) 看成 gRPC 服务，可以看出它们之间的交互路径：
---> gRPC server pod1 gRPC-client ---> ipvs ---> gRPC server pod3 ---> gRPC server pod3 我们知道gRPC是基于HTTP/2协议的，gRPC的client和server在交互时会建立多条连接，为了性能，这些连接都是长连接并且是一直保活的。这段环境中不管是客户端服务还是 gRPC 服务都被调度到各个相同配置信息的 Kubernetes 节点上，这些 k8s 节点的 keep-alive 是一致的，如果出现连接主动关闭的问题，因为从 client 到 server 经历了一层 ipvs，所以最大的可能就是 ipvs 出将连接主动断开，而 client 端还不知情。 搜索 ipvs timeout 关键字找到了下面相关的链接：
...</p></div><footer class=entry-footer><span title='2019-07-22 12:40:20 +0800 +0800'>2019-07-22</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;L</footer><a class=entry-link aria-label="post link to gRPC Connection reset by peer 问题" href=https://lvlv.fun/posts/2019-07-22/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>gRPC error code</h2></header><div class=entry-content><p>RPC.response.status.code HTTP RPC Description 0 - OK 200 OK Not an error; returned on success. 1 - CANCELLED 499 Client Closed Request The operation was cancelled, typically by the caller. 2 - UNKNOWN 500 Internal Server Error Unknown error. For example, this error may be returned when a Status value received from another address space belongs to an error space that is not known in this address space. Also errors raised by APIs that do not return enough error information may be converted to this error. 3 - INVALID_ARGUMENT 400 Bad Request The client specified an invalid argument. Note that this differs from FAILED_PRECONDITION. INVALID_ARGUMENT indicates arguments that are problematic regardless of the state of the system (e.g., a malformed file name). 4 - DEADLINE_EXCEEDED 504 Gateway Timeout The deadline expired before the operation could complete. For operations that change the state of the system, this error may be returned even if the operation has completed successfully. For example, a successful response from a server could have been delayed long enough for the deadline to expire. 5 - NOT_FOUND 404 Not Found Some requested entity (e.g., file or directory) was not found.Note to server developers: if a request is denied for an entire class of users, such as gradual feature rollout or undocumented whitelist,NOT_FOUND may be used. If a request is denied for some users within a class of users, such as user-based access control, PERMISSION_DENIED must be used. 6 - ALREADY_EXISTS 409 Conflict The entity that a client attempted to create (e.g., file or directory) already exists. 7 - PERMISSION_DENIED 403 Forbidden The caller does not have permission to execute the specified operation. PERMISSION_DENIED must not be used for rejections caused by exhausting some resource (use RESOURCE_EXHAUSTED instead for those errors). PERMISSION_DENIED must not be used if the caller can not be identified (use UNAUTHENTICATED instead for those errors). This error code does not imply the request is valid or the requested entity exists or satisfies other pre-conditions. 8 - RESOURCE_EXHAUSTED 429 Too Many Requests Some resource has been exhausted, perhaps a per-user quota, or perhaps the entire file system is out of space. 9 - FAILED_PRECONDITION 400 Bad Request The operation was rejected because the system is not in a state required for the operation’s execution. For example, the directory to be deleted is non-empty, an rmdir operation is applied to a non-directory, etc.Service implementors can use the following guidelines to decide between FAILED_PRECONDITION, ABORTED, and UNAVAILABLE: (a) Use UNAVAILABLE if the client can retry just the failing call. (b) Use ABORTED if the client should retry at a higher level (e.g., when a client-specified test-and-set fails, indicating the client should restart a read-modify-write sequence). (c) Use FAILED_PRECONDITION if the client should not retry until the system state has been explicitly fixed. E.g., if an “rmdir” fails because the directory is non-empty, FAILED_PRECONDITION should be returned since the client should not retry unless the files are deleted from the directory. 10 - ABORTED 409 Conflict The operation was aborted, typically due to a concurrency issue such as a sequencer check failure or transaction abort.See the guidelines above for deciding between FAILED_PRECONDITION,ABORTED, and UNAVAILABLE. 11 - OUT_OF_RANGE 400 Bad Request The operation was attempted past the valid range. E.g., seeking or reading past end-of-file.Unlike INVALID_ARGUMENT, this error indicates a problem that may be fixed if the system state changes. For example, a 32-bit file system will generate INVALID_ARGUMENT if asked to read at an offset that is not in the range [0,2^32-1], but it will generate OUT_OF_RANGE if asked to read from an offset past the current file size.There is a fair bit of overlap between FAILED_PRECONDITION and OUT_OF_RANGE. We recommend using OUT_OF_RANGE (the more specific error) when it applies so that callers who are iterating through a space can easily look for an OUT_OF_RANGE error to detect when they are done. 12 - UNIMPLEMENTED 501 Not Implemented The operation is not implemented or is not supported/enabled in this service. 13 - INTERNAL 500 Internal Server Error Internal errors. This means that some invariants expected by the underlying system have been broken. This error code is reserved for serious errors. 14 - UNAVAILABLE 503 Service Unavailable The service is currently unavailable. This is most likely a transient condition, which can be corrected by retrying with a backoff.See the guidelines above for deciding between FAILED_PRECONDITION,ABORTED, and UNAVAILABLE. 15 - DATA_LOSS 500 Internal Server Error Unrecoverable data loss or corruption. 16 - UNAUTHENTICATED 401 Unauthorized The request does not have valid authentication credentials for the peration.</p></div><footer class=entry-footer><span title='2019-06-12 20:04:20 +0800 +0800'>2019-06-12</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;L</footer><a class=entry-link aria-label="post link to gRPC error code" href=https://lvlv.fun/posts/2019-06-12/></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://lvlv.fun/>Lv's Playground</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>