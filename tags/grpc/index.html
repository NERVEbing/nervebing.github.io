<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>gRPC | Lv's Playground</title><meta name=keywords content><meta name=description content="Lv's Playground"><meta name=author content="L"><link rel=canonical href=https://lvlv.fun/tags/grpc/><link crossorigin=anonymous href=/assets/css/stylesheet.36dc2f0e1e765691808017c48a6ba0f6b4614b9e123e6469d834c462ebb3dad5.css integrity="sha256-NtwvDh52VpGAgBfEimug9rRhS54SPmRp2DTEYuuz2tU=" rel="preload stylesheet" as=style><link rel=icon href=https://lvlv.fun/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lvlv.fun/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://lvlv.fun/favicon-32x32.png><link rel=apple-touch-icon href=https://lvlv.fun/apple-touch-icon.png><link rel=mask-icon href=https://lvlv.fun/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://lvlv.fun/tags/grpc/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script>var _paq=window._paq=window._paq||[];_paq.push(['trackPageView']),_paq.push(['enableLinkTracking']),function(){e="//matomo.lvlv.fun/",_paq.push(['setTrackerUrl',e+'matomo.php']),_paq.push(['setSiteId','1']);var e,n=document,t=n.createElement('script'),s=n.getElementsByTagName('script')[0];t.async=!0,t.src=e+'matomo.js',s.parentNode.insertBefore(t,s)}()</script><meta property="og:title" content="gRPC"><meta property="og:description" content="Lv's Playground"><meta property="og:type" content="website"><meta property="og:url" content="https://lvlv.fun/tags/grpc/"><meta property="og:image" content="https://lvlv.fun/apple-touch-icon.png"><meta property="og:site_name" content="Lv's Playground"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://lvlv.fun/apple-touch-icon.png"><meta name=twitter:title content="gRPC"><meta name=twitter:description content="Lv's Playground"></head><body class="list dark" id=top><header class=header><nav class=nav><div class=logo><a href=https://lvlv.fun accesskey=h title="Started (Alt + H)"><img src=https://lvlv.fun/apple-touch-icon.png alt=logo aria-label=logo height=35>Started</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://lvlv.fun/navigation/ title=Navigation><span>Navigation</span></a></li><li><a href=https://lvlv.fun/live/ title=Live><span>Live</span></a></li><li><a href=https://lvlv.fun/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://lvlv.fun/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://lvlv.fun>Home</a>&nbsp;»&nbsp;<a href=https://lvlv.fun/tags/>Tags</a></div><h1>gRPC</h1></header><article class="post-entry tag-entry"><div class=post-info><header class=entry-header><h2>使用 Rust 构建 gRPC 微服务</h2></header><div class=entry-content><p>前言 当前越来越多的公司基于 Google gRPC 通信框架来构建微服务体系，比较流行的是使用 Go/Java/C++ 这样的主流编程语言来编写服务端，我们今天来尝试使用 Rust 语言来实现一个 gRPC 服务端/客户端。
打开官方文档可以看到目前 Rust 并不在 gRPC 官方支持的语言列表中：
Supported languages
C# C++ Dart Go Java Kotlin Node Objective-C PHP Python Ruby 不过不用担心这个问题。我们知道只要某个语言兼容了基于 C/C++ 编写的 gRPC 的核心库，那么该语言就可以完美支持 gRPC。目前 Rust 可以实现 gRPC 的主流 crate 如下：
tonic grpc-rs grpc-rust 以上三种任选其一都可以，只是 grpc-rs/grpc-rust 当前还处于开发状态，我们在这里使用 tonic 包。
构建程序 首先检查你的 Rust 版本：
$ rustc --version rustc 1.61.0 (fe5b13d68 2022-05-18) tonic 适用于 1.56 及以上，如果低于这个版本，你应该先更新你的 Rust 编译器：
$ rustup update stable 确保你已经提前安装了 protobuf：...</p></div><footer class=entry-footer><span title='2022-05-30 02:25:11 +0800 +0800'>2022-05-30</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;L</footer></div><a class=entry-link aria-label="post link to 使用 Rust 构建 gRPC 微服务" href=https://lvlv.fun/posts/2022-05-30/></a></article><article class="post-entry tag-entry"><div class=post-info><header class=entry-header><h2>gRPC Connection reset by peer 问题</h2></header><div class=entry-content><p>前提 因产品需求，需用PHP（v7.0.12）调用k8s集群中gRPC（golang@1.12.0）服务。
问题 经过dev环境测试，当php-fpm启动后第一次调用或者距离上次调用时间20分钟后左右，再次请求gRPC微服务接口，就会返回 Connection reset by peer 错误，说明gRPC服务端或者客户端主动关闭连接了。继续发起请求到服务端，又恢复正常。
思考 经查阅相关资料，发现问题可能出现在k8s集群的kube-proxy模式上。当前k8s环境(dev)下的kube-proxy为ipvs模式，服务端与客户端之间通信如下：
把上图client看成是apsopen-inside服务pod，Backend pod(1~3)看成gRPC服务，可以看出它们之间的交互路径：
---> gRPC server pod1 gRPC-client ---> ipvs ---> gRPC server pod3 ---> gRPC server pod3 我们知道gRPC是基于HTTP/2协议的，gRPC的client和server在交互时会建立多条连接，为了性能，这些连接都是长连接并且是一直保活的。 这段环境中不管是客户端服务还是gRPC服务都被调度到各个相同配置信息的Kubernetes节点上，这些k8s节点的 keep-alive 是一致的，如果出现连接主动关闭的问题，因为从client到server经历了一层ipvs，所以最大的可能就是ipvs出将连接主动断开，而client端还不知情。 搜索 ipvs timeout 关键字找到了下面相关的链接：
https://github.com/moby/moby/issues/31208 https://success.docker.com/article/ipvs-connection-timeout-issue https://github.com/kubernetes/kubernetes/issues/32457 其中 https://github.com/moby/moby/issues/31208 中是关于docker swarm在overlay网络下长连接的问题，这个和k8s kube-proxy应该是类似的，按照这个链接中的描述查看 我们这套环境关于tcp keepalive的内核参数：
#进入igo-util-shorturi容器 sysctl net.ipv4.tcp_keepalive_time net.ipv4.tcp_keepalive_probes net.ipv4.tcp_keepalive_intvl net.ipv4.tcp_keepalive_time = 7200 net.ipv4.tcp_keepalive_probes = 9 net.ipv4.tcp_keepalive_intvl = 75 上面这段参数的含义: net.ipv4.tcp_keepalive_time 是连接时长，当超过这个时间后，每个 net.ipv4.tcp_keepalive_intvl 的时间间隔会发送keepalive数据包， net.ipv4.tcp_keepalive_probe 是发送keepalived数据包的频率。
解决 使用 ipvsadm 命令查看k8s节点上ipvs的超时时间：...</p></div><footer class=entry-footer><span title='2019-07-22 12:40:20 +0800 +0800'>2019-07-22</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;L</footer></div><a class=entry-link aria-label="post link to gRPC Connection reset by peer 问题" href=https://lvlv.fun/posts/2019-07-22/></a></article><article class="post-entry tag-entry"><div class=post-info><header class=entry-header><h2>gRPC error code</h2></header><div class=entry-content><p>RPC.response.status.code HTTP RPC Description 0 - OK 200 OK Not an error; returned on success. 1 - CANCELLED 499 Client Closed Request The operation was cancelled, typically by the caller. 2 - UNKNOWN 500 Internal Server Error Unknown error. For example, this error may be returned when a Status value received from another address space belongs to an error space that is not known in this address space. Also errors raised by APIs that do not return enough error information may be converted to this error....</p></div><footer class=entry-footer><span title='2019-06-12 20:04:20 +0800 +0800'>2019-06-12</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;L</footer></div><a class=entry-link aria-label="post link to gRPC error code" href=https://lvlv.fun/posts/2019-06-12/></a></article></main><footer class=footer><span>&copy; 2022 <a href=https://lvlv.fun>Lv's Playground</a></span>
<span>|</span>
<span><img style=display:inline;margin-bottom:-1em src="https://matomo.lvlv.fun/index.php?module=FlagCounter&action=image&idSite=1&period=range&date=last7&sort=popular&activated=&rows=1&cols=5&showcode=1&showflag=1&fontsize=10&fontcolor=218,218,219" alt=flag></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>